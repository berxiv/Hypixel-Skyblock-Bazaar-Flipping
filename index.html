<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SkyBlock Bazaar Flip Leaderboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --accent:#0b7dda;
      --muted:#666;
      --success:#0a8a3b;
      --danger:#c0392b;
      --card:#fff;
      --bg:#f5f7fb;
    }
    body{
      margin:16px;
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:var(--bg);
      color:#111;
    }
    header{display:flex;gap:16px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:1.25rem}
    .controls{display:flex;gap:8px;align-items:center;margin-left:auto}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    label{font-size:.85rem;color:var(--muted)}
    input[type=number]{width:100px;padding:6px;border-radius:8px;border:1px solid #ddd}
    button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #eef2f7;text-align:right;font-variant-numeric:tabular-nums}
    th.left,td.left{text-align:left}
    th{background:linear-gradient(180deg,#fbfdff,#f2f6fb);font-weight:600}
    tr.positive td.profit{color:var(--success);font-weight:700}
    tr.negative td.profit{color:var(--danger)}
    .small{font-size:.85rem;color:var(--muted)}
    .loading{color:var(--muted);font-style:italic}
    .note{margin-top:8px;color:var(--muted);font-size:.9rem}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <header>
    <h1>SkyBlock Bazaar — High-Volume Flip Leaderboard</h1>
    <div class="controls card">
      <div style="display:flex;gap:8px;align-items:center;">
        <label>Min daily trades</label>
        <input id="minVolume" type="number" value="5000" min="0" />
      </div>
      <button id="refreshBtn">Refresh</button>
    </div>
  </header>

  <div class="card" id="content">
    <div id="status" class="loading">Loading bazaar &amp; items... (this may take 1–3s)</div>

    <table id="leaderboard" style="display:none">
      <thead>
        <tr>
          <th>Rank</th>
          <th class="left">Item</th>
          <th>Buy</th>
          <th>Sell</th>
          <th>Daily trades</th>
          <th>Profit @ 1700</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="note">
      <strong>How it works:</strong> Uses Hypixel’s Bazaar API and SkyBlock items resource.  
      Daily trades = weekly moving average ÷ 7.  
      Profit = (buyPrice – sellPrice) × 1700.  
      Items must pass filters (≥ min daily trades).  
      Skips any item with buy/sell price ≤ 0.
    </div>
  </div>

  <script>
  const BAZAAR_URL = 'https://api.hypixel.net/v2/skyblock/bazaar';
  const ITEMS_URL  = 'https://api.hypixel.net/resources/skyblock/items';
  const FLIP_QTY = 1700;

  async function fetchJsonWithFallback(url) {
    try {
      const r = await fetch(url, {cache: 'no-cache'});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      return await r.json();
    } catch (err) {
      const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
      const r2 = await fetch(proxy, {cache: 'no-cache'});
      if (!r2.ok) throw new Error('Proxy HTTP ' + r2.status);
      return await r2.json();
    }
  }

  const statusEl = document.getElementById('status');
  const tableEl = document.getElementById('leaderboard');
  const tbody = tableEl.querySelector('tbody');
  const refreshBtn = document.getElementById('refreshBtn');

  async function build() {
    const minDaily = Number(document.getElementById('minVolume').value) || 5000;

    statusEl.textContent = 'Fetching Bazaar data...';
    tableEl.style.display = 'none';
    tbody.innerHTML = '';

    let bazaarData, itemsData;
    try {
      [bazaarData, itemsData] = await Promise.all([
        fetchJsonWithFallback(BAZAAR_URL),
        fetchJsonWithFallback(ITEMS_URL)
      ]);
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Failed to fetch API — see console for details. ' + (err.message || '');
      return;
    }

    if (!bazaarData?.products || !itemsData?.items) {
      statusEl.textContent = 'Missing data from API.';
      return;
    }

    statusEl.textContent = 'Processing items...';
    const itemsMap = new Map(itemsData.items.map(it => [it.id, it]));
    const results = [];

    for (const [key, p] of Object.entries(bazaarData.products)) {
      const qs = p.quick_status || {};
      const buyPrice  = typeof qs.buyPrice === 'number' && qs.buyPrice > 0 ? qs.buyPrice : (p.buy_summary?.[0]?.pricePerUnit ?? null);
      const sellPrice = typeof qs.sellPrice === 'number' && qs.sellPrice > 0 ? qs.sellPrice : (p.sell_summary?.[0]?.pricePerUnit ?? null);

      const buyMovingWeek  = Number(qs.buyMovingWeek  ?? 0);
      const sellMovingWeek = Number(qs.sellMovingWeek ?? 0);
      const weeklyMoving = Math.max(buyMovingWeek, sellMovingWeek);
      const dailyMoving = weeklyMoving / 7;

      // Skip bad data
      if (!buyPrice || !sellPrice || buyPrice <= 0 || sellPrice <= 0) continue;
      if (dailyMoving < minDaily) continue;

      const meta = itemsMap.get(key);
      const profit = (buyPrice - sellPrice) * FLIP_QTY;
      if (!(profit > 0)) continue;

      results.push({
        id: key,
        name: meta?.name ?? key,
        buyPrice,
        sellPrice,
        dailyMoving,
        profit
      });
    }

    results.sort((a,b)=>b.profit - a.profit);

    if (!results.length) {
      statusEl.textContent = 'No items matched the filters.';
      return;
    }

    const nf = x => Number.isFinite(x) ? x.toLocaleString(undefined, {maximumFractionDigits:2}) : '-';
    results.slice(0,200).forEach((r, idx) => {
      const tr = document.createElement('tr');
      tr.className = r.profit > 0 ? 'positive' : 'negative';
      tr.innerHTML = `
        <td class="nowrap">${idx+1}</td>
        <td class="left">
          <div style="display:flex;flex-direction:column;">
            <span style="font-weight:600">${escapeHtml(r.name)}</span>
            <span class="small">${escapeHtml(r.id)}</span>
          </div>
        </td>
        <td>${nf(r.buyPrice)}</td>
        <td>${nf(r.sellPrice)}</td>
        <td>${Math.round(r.dailyMoving).toLocaleString()}</td>
        <td class="profit">${nf(r.profit)}</td>
      `;
      tbody.appendChild(tr);
    });

    statusEl.textContent = `Showing ${results.length} items. Top ${Math.min(results.length,200)} displayed. Last fetched: ${new Date().toLocaleString()}`;
    tableEl.style.display = '';
  }

  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  refreshBtn.addEventListener('click', build);
  build();
  </script>

</body>
</html>